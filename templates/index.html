<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chor Police - Landing Page</title>
    <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-200">
    <div class="container mx-auto p-4">
        <h1 class="text-2xl font-bold text-center">Chor Police</h1>
        <div id="landing" class="text-center mt-4">
            <button onclick="createRoom()" class="bg-blue-500 text-white p-2 m-2">Create Room</button>
            <input id="room-key" class="border p-2" placeholder="Enter Room Key"/>
            <button onclick="joinRoom()" class="bg-green-500 text-white p-2 m-2">Join Room</button>
        </div>
        <div id="game" class="mt-4 hidden">
            <h2 id="player-name" class="text-xl font-bold"></h2>
            <p id="round-number" class="text-lg font-semibold text-center mt-2"></p>
            <button id="start-shuffle" onclick="startShuffle()" class="bg-green-500 text-white p-2 mt-2 hidden">Start Shuffle</button>
            <div id="dashboard" class="mt-4">
                <!-- Player's dashboard will be updated here -->
            </div>
        </div>
        <div id="game-over" class="hidden">
            <h2 class="text-xl font-bold">Game Over</h2>
            <p id="game-over-round" class="font-semibold text-lg"></p>
            <div id="rankings">
                <!-- Rankings will be displayed here -->
            </div>
            <button id="rematch-button" onclick="rematchGame()" class="bg-yellow-500 text-white p-2 mt-4">Rematch</button>
        </div>
    </div>
    <script>
        var socket = io();
        var username;
        var roomKey;
        var king;
        var police;
        var players = {};
        var roundNumber;
        var maxRounds;
        var currentTurn;

        function createRoom() {
            socket.emit('create_room');
        }

        socket.on('room_created', function(data) {
            roomKey = data.room_key;
            alert(`Room created! Your room key is: ${roomKey}`);
            document.getElementById('room-key').value = roomKey;
        });

        function joinRoom() {
            username = prompt("Enter your name:");
            roomKey = document.getElementById('room-key').value;
            socket.emit('join_room', {'room_key': roomKey, 'username': username});
            document.getElementById('landing').classList.add('hidden');
            document.getElementById('game').classList.remove('hidden');
            document.getElementById('player-name').innerText = `Hello, ${username}`;
        }

        function startShuffle() {
            socket.emit('start_shuffle', {'room_key': roomKey});
        }

        socket.on('start_shuffle', function(data) {
            roundNumber = data.round;
            maxRounds = data.max_rounds;
            currentTurn = data.current_turn;
            document.getElementById('round-number').innerText = `Round ${roundNumber}/${maxRounds}`;
            if (currentTurn === Object.keys(players).indexOf(username)) {
                document.getElementById('start-shuffle').classList.remove('hidden');
            }
        });

        socket.on('cards_assigned', function(data) {
            players = data.players;
            roundNumber = data.round;
            maxRounds = data.max_rounds;
            currentTurn = data.current_turn;
            var dashboard = document.getElementById('dashboard');
            dashboard.innerHTML = Object.keys(players).map(player => 
                `<p>${player} (${players[player].card}): ${players[player].points} points</p>`
            ).join('');
            document.getElementById('round-number').innerText = `Round ${roundNumber}/${maxRounds}`;
            
            if (players[username].card === "King") {
                var kingOptions = `<button onclick="giveOrder('Thief')" class="bg-red-500 text-white p-2 mt-2">Catch Thief</button>
                                   <button onclick="giveOrder('Robbery')" class="bg-red-500 text-white p-2 mt-2">Catch Robbery</button>`;
                dashboard.innerHTML += `<div>${kingOptions}</div>`;
            }
            if (players[username].card === "Police") {
                king = Object.keys(players).find(p => players[p].card === "King");
                document.getElementById('dashboard').innerHTML += `<p>Waiting for King (${king}) to give an order...</p>`;
            }
        });

        socket.on('police_order', function(data) {
            if (players[username].card === "Police") {
                var options = Object.keys(players).filter(p => p !== username && p !== data.king).map(p => 
                    `<button onclick="policeAction('${p}', '${data.command}')" class="bg-red-500 text-white p-2 mt-2">Catch ${p}</button>`
                ).join('');
                var dashboard = document.getElementById('dashboard');
                dashboard.innerHTML += `<p>As Police, choose a player to catch</p>${options}`;
            }
        });

        socket.on('update', function(data) {
            players = data.players;
            var dashboard = document.getElementById('dashboard');
            dashboard.innerHTML = Object.keys(players).map(player => 
                `<p>${player} (${players[player].card}): ${players[player].points} points</p>`
            ).join('');
        });

        socket.on('round_complete', function(data) {
            players = data.players;
            roundNumber = data.round;
            document.getElementById('round-number').innerText = `Round ${roundNumber}/${maxRounds}`;
            var dashboard = document.getElementById('dashboard');
            dashboard.innerHTML = Object.keys(players).map(player => 
                `<p>${player} (${players[player].card}): ${players[player].points} points</p>`
            ).join('');
        });

        socket.on('game_over', function(data) {
            document.getElementById('game').classList.add('hidden');
            document.getElementById('game-over').classList.remove('hidden');
            document.getElementById('game-over-round').innerText = `Game Over! Rounds played: ${data.round}`;
            var rankingsDiv = document.getElementById('rankings');
            rankingsDiv.innerHTML = '<h3>Rankings:</h3>';
            data.rankings.forEach(function(rank, index) {
                rankingsDiv.innerHTML += `<p>${index + 1}. ${rank.username}: ${rank.points} points</p>`;
            });
        });

        function giveOrder(command) {
            socket.emit('king_order', {'king': username, 'command': command, 'room_key': roomKey});
        }

        function policeAction(target, command) {
            socket.emit('police_action', {'police': username, 'target': target, 'command': command, 'king': king, 'room_key': roomKey});
        }

        function rematchGame() {
            socket.emit('rematch', {'room_key': roomKey});
            document.getElementById('game-over').classList.add('hidden');
            document.getElementById('game').classList.remove('hidden');
        }
    </script>
</body>
</html>
